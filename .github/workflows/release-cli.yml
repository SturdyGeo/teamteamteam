name: Release CLI

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build-binaries:
    name: Build ${{ matrix.asset_arch }}
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - runner: macos-14
            asset_arch: arm64
          - runner: macos-13
            asset_arch: amd64

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Build standalone CLI
        run: bun run build:cli

      - name: Verify standalone binary
        run: ./dist/ttteam --version

      - name: Package archive and checksum
        run: |
          set -euo pipefail
          ARCHIVE="ttteam-darwin-${{ matrix.asset_arch }}.tar.gz"
          STAGING_DIR="release/${{ matrix.asset_arch }}"

          mkdir -p "$STAGING_DIR"
          cp dist/ttteam "$STAGING_DIR/ttteam"
          chmod +x "$STAGING_DIR/ttteam"

          tar -C "$STAGING_DIR" -czf "release/$ARCHIVE" ttteam
          shasum -a 256 "release/$ARCHIVE" > "release/$ARCHIVE.sha256"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-${{ matrix.asset_arch }}
          path: release/*

  publish-release:
    name: Publish release + update Homebrew tap
    runs-on: ubuntu-latest
    needs: build-binaries

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: release-*
          merge-multiple: true
          path: release

      - name: Compute release metadata
        run: |
          set -euo pipefail
          VERSION="${GITHUB_REF_NAME#v}"
          ARM64_SHA="$(awk '{print $1}' release/ttteam-darwin-arm64.tar.gz.sha256)"
          AMD64_SHA="$(awk '{print $1}' release/ttteam-darwin-amd64.tar.gz.sha256)"

          echo "VERSION=$VERSION" >> "$GITHUB_ENV"
          echo "ARM64_SHA=$ARM64_SHA" >> "$GITHUB_ENV"
          echo "AMD64_SHA=$AMD64_SHA" >> "$GITHUB_ENV"

      - name: Verify release checksums
        run: |
          set -euo pipefail
          cd release
          shasum -a 256 -c ttteam-darwin-arm64.tar.gz.sha256
          shasum -a 256 -c ttteam-darwin-amd64.tar.gz.sha256

      - name: Publish GitHub release
        uses: softprops/action-gh-release@v2
        with:
          token: ${{ secrets.RELEASE_GITHUB_TOKEN }}
          name: ${{ github.ref_name }}
          generate_release_notes: true
          fail_on_unmatched_files: true
          files: |
            release/ttteam-darwin-arm64.tar.gz
            release/ttteam-darwin-amd64.tar.gz
            release/ttteam-darwin-arm64.tar.gz.sha256
            release/ttteam-darwin-amd64.tar.gz.sha256

      - name: Resolve tap repository
        run: |
          set -euo pipefail
          TAP_REPO="${{ vars.HOMEBREW_TAP_REPOSITORY }}"
          if [ -z "$TAP_REPO" ]; then
            TAP_REPO="${{ github.repository_owner }}/homebrew-teamteamteam"
          fi
          echo "TAP_REPO=$TAP_REPO" >> "$GITHUB_ENV"

      - name: Generate Homebrew formula
        run: |
          set -euo pipefail
          node ./scripts/generate-homebrew-formula.mjs \
            --version "$VERSION" \
            --repository "${{ github.repository }}" \
            --arm64-sha "$ARM64_SHA" \
            --amd64-sha "$AMD64_SHA" \
            --output "release/ttteam.rb"

      - name: Validate tap token
        run: |
          if [ -z "${{ secrets.RELEASE_GITHUB_TOKEN }}" ]; then
            echo "Missing secret RELEASE_GITHUB_TOKEN"
            exit 1
          fi

          if [ -z "${{ secrets.HOMEBREW_TAP_GITHUB_TOKEN }}" ]; then
            echo "Missing secret HOMEBREW_TAP_GITHUB_TOKEN"
            exit 1
          fi

      - name: Update Homebrew tap formula
        env:
          TAP_TOKEN: ${{ secrets.HOMEBREW_TAP_GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          git clone "https://x-access-token:${TAP_TOKEN}@github.com/${TAP_REPO}.git" tap

          mkdir -p tap/Formula
          cp release/ttteam.rb tap/Formula/ttteam.rb

          cd tap
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git add Formula/ttteam.rb

          if git diff --cached --quiet -- Formula/ttteam.rb; then
            echo "Formula already up to date."
            exit 0
          fi

          git commit -m "ttteam v${VERSION}"
          git push origin HEAD
